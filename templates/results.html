{% extends 'base_app.html' if current_user.is_authenticated else 'base_minimal.html' %}
{% from 'components/icons.html' import icon %}

{% block title %}Results: {{ poll.question|truncate(50) }} - Pollivu{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/poll.css') }}">
<style>
    .results-page {
        max-width: 800px;
        margin: 40px auto;
        padding: 0 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="results-page">
    <!-- Poll Header -->
    <div class="poll-header">
        <h1 class="poll-question">{{ poll.question }}</h1>

        <div class="poll-status-badges">
            {% if poll.is_expired %}
            <span class="status-badge status-expired">
                {{ icon('clock') }}
                Expired
            </span>
            {% elif poll.is_closed %}
            <span class="status-badge status-closed">
                {{ icon('private') }}
                Closed
            </span>
            {% else %}
            <span class="status-badge status-active">
                {{ icon('active_polls') }}
                Active
            </span>
            {% endif %}
        </div>

        <div class="poll-meta">
            {% if poll.time_remaining and poll.is_active %}
            <div class="poll-meta-item">
                {{ icon('clock') }}
                <span>Expires in {{ poll.time_remaining|format_time }}</span>
            </div>
            {% endif %}
            <div class="poll-meta-item">
                {{ icon('total_votes') }}
                <span id="total-votes-count">{{ poll.total_votes }}</span> total votes
            </div>
            <div class="poll-meta-item">
                {{ icon('calendar') }}
                Created {{ poll.created_at.strftime('%b %d, %Y') }}
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="results-content">
        <!-- Empty State (No Votes Yet) -->
        {% if poll.total_votes == 0 %}
        <div class="no-votes-empty-state" id="no-votes-state">
            <div class="empty-illustration">
                <svg width="120" height="120" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <!-- Ballot box -->
                    <rect x="25" y="45" width="70" height="55" rx="8" fill="#D1FAE5" stroke="#10B981" stroke-width="2.5"/>
                    <rect x="25" y="45" width="70" height="16" rx="8" fill="#10B981"/>
                    <rect x="50" y="49" width="20" height="8" rx="3" fill="#D1FAE5"/>
                    <!-- Paper/ballot going in -->
                    <rect x="42" y="15" width="36" height="40" rx="4" fill="white" stroke="#10B981" stroke-width="2" stroke-dasharray="4 3">
                        <animateTransform attributeName="transform" type="translate" values="0,0; 0,5; 0,0" dur="2s" repeatCount="indefinite"/>
                    </rect>
                    <line x1="50" y1="25" x2="70" y2="25" stroke="#A7F3D0" stroke-width="2" stroke-linecap="round">
                        <animateTransform attributeName="transform" type="translate" values="0,0; 0,5; 0,0" dur="2s" repeatCount="indefinite"/>
                    </line>
                    <line x1="50" y1="31" x2="66" y2="31" stroke="#A7F3D0" stroke-width="2" stroke-linecap="round">
                        <animateTransform attributeName="transform" type="translate" values="0,0; 0,5; 0,0" dur="2s" repeatCount="indefinite"/>
                    </line>
                    <line x1="50" y1="37" x2="62" y2="37" stroke="#A7F3D0" stroke-width="2" stroke-linecap="round">
                        <animateTransform attributeName="transform" type="translate" values="0,0; 0,5; 0,0" dur="2s" repeatCount="indefinite"/>
                    </line>
                    <!-- Sparkles -->
                    <circle cx="90" cy="30" r="3" fill="#34D399" opacity="0.6">
                        <animate attributeName="opacity" values="0.6;1;0.6" dur="1.5s" repeatCount="indefinite"/>
                    </circle>
                    <circle cx="22" cy="40" r="2" fill="#6EE7B7" opacity="0.5">
                        <animate attributeName="opacity" values="0.5;1;0.5" dur="2s" repeatCount="indefinite"/>
                    </circle>
                    <circle cx="98" cy="55" r="2.5" fill="#A7F3D0" opacity="0.7">
                        <animate attributeName="opacity" values="0.7;1;0.7" dur="1.8s" repeatCount="indefinite"/>
                    </circle>
                </svg>
            </div>
            <h3 class="empty-title">No votes yet</h3>
            <p class="empty-subtitle">Be the first to vote and see the results come to life!</p>
            {% if poll.is_active and not has_voted %}
            <a href="{{ url_for('polls.view_poll', poll_id=poll.id) }}" class="btn btn-primary btn-lg empty-cta">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
                Cast the First Vote
            </a>
            {% elif not poll.is_active %}
            <p class="empty-hint">This poll is no longer accepting votes.</p>
            {% endif %}
            <div class="empty-share-hint">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity: 0.5;">
                    <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                </svg>
                <span>Share the poll link to start collecting votes</span>
            </div>
        </div>
        {% endif %}

        {% set show_chart = is_creator or (poll.share_results_chart is not none and poll.share_results_chart) or (poll.share_results_chart is none) %}
        {% set show_list = is_creator or (poll.share_results_list is not none and poll.share_results_list) or (poll.share_results_list is none) %}
        {% if show_list %}
        <div class="results-list" id="results-list">
            {% for option in poll.options|sort(attribute='vote_count', reverse=True) %}
            <div class="result-item" data-option-id="{{ option.id }}">
                <div class="result-header">
                    <span class="result-text">
                        {{ option.option_text }}
                        {% if voted_option_id == option.id %}
                        <span class="your-vote-badge">Your vote</span>
                        {% endif %}
                    </span>
                    <span class="result-stats">
                        <span class="vote-count">{{ option.vote_count }}</span> votes
                        (<span class="percentage">{{ option.percentage }}</span>%)
                    </span>
                </div>
                <div class="result-bar-container">
                    <div class="result-bar" style="width: {{ option.percentage }}%"></div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <!-- Still show option names without stats -->
        <div class="results-list results-list-minimal">
            {% for option in poll.options|sort(attribute='display_order') %}
            <div class="result-item">
                <div class="result-header">
                    <span class="result-text">
                        {{ option.option_text }}
                        {% if voted_option_id == option.id %}
                        <span class="your-vote-badge">Your vote</span>
                        {% endif %}
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if has_voted %}
        <div class="voted-message">
            {{ icon('info_check') }}
            <span>Thanks for voting!</span>
        </div>
        {% endif %}

        {% if poll.is_active and not has_voted %}
        <a href="{{ url_for('polls.view_poll', poll_id=poll.id) }}" class="btn btn-primary btn-lg">
            Cast Your Vote
        </a>
        {% endif %}
    </div>

    <!-- Visualizations Section -->
    {% set show_insights = is_creator or (poll.share_insights is not none and poll.share_insights) or (poll.share_insights is none) %}
    {% if show_insights %}
    <div class="visualizations-section" style="margin-top: 40px;">
        <h3 class="section-title">Insights</h3>

        <!-- Votes Over Time -->
        <div class="chart-card chart-card-full">
            <div class="chart-title-row">
                <h4 class="chart-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: -3px; margin-right: 6px; opacity: 0.5;">
                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                    </svg>
                    Votes Over Time
                </h4>
                <div class="granularity-tabs" id="granularity-tabs">
                    <button class="granularity-tab active" data-granularity="hourly">Hourly</button>
                    <button class="granularity-tab" data-granularity="daily">Daily</button>
                    <button class="granularity-tab" data-granularity="cumulative">Cumulative</button>
                </div>
            </div>
            <div class="chart-canvas-wrap">
                <canvas id="votesTimeChart"></canvas>
            </div>
            <div class="chart-empty-state" id="timeline-empty" style="display: none;">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.3">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                </svg>
                <span>Votes will appear here as they come in</span>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Export & Share only visible when at least chart or list is shared -->
    {% if show_chart or show_list %}
    <!-- Export Section -->
    <div class="export-section" style="margin-top: 40px;">
        <h3 class="export-title">Export Results</h3>
        <div class="export-buttons">
            <a href="{{ url_for('polls.export_csv', poll_id=poll.id) }}" class="btn btn-secondary">
                {{ icon('download') }}
                Download CSV
            </a>
        </div>
    </div>

    <!-- Share Section -->
    <div class="share-section">
        <h3 class="share-title">Share Results</h3>
        <div class="share-buttons">
            <button class="share-btn" onclick="copyLinkToClipboard()" aria-label="Copy link to clipboard">
                {{ icon('copy') }}
                Copy Link
            </button>
            <a href="https://twitter.com/intent/tweet?url={{ request.url|urlencode }}&text={{ ('Poll Results: ' ~ poll.question)|urlencode }}"
                target="_blank" rel="noopener noreferrer" class="share-btn share-twitter" aria-label="Share on Twitter">
                {{ icon('twitter') }}
                Twitter
            </a>
            <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.url|urlencode }}" target="_blank"
                rel="noopener noreferrer" class="share-btn share-facebook" aria-label="Share on Facebook">
                {{ icon('facebook') }}
                Facebook
            </a>
            <a href="https://wa.me/?text={{ ('Poll Results: ' ~ poll.question ~ ' ' ~ request.url)|urlencode }}" target="_blank"
                rel="noopener noreferrer" class="share-btn share-whatsapp" aria-label="Share on WhatsApp">
                {{ icon('whatsapp') }}
                WhatsApp
            </a>
            <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.url|urlencode }}" target="_blank"
                rel="noopener noreferrer" class="share-btn share-linkedin" aria-label="Share on LinkedIn">
                {{ icon('linkedin') }}
                LinkedIn
            </a>
            <a href="#" onclick="showQrModal('{{ poll.id }}'); return false;" class="share-btn" aria-label="Show QR Code">
                {{ icon('qr') }}
                QR Code
            </a>
            <button class="share-btn share-embed" onclick="copyEmbedCode('{{ poll.id }}')" aria-label="Copy embed code">
                {{ icon('code') }}
                Embed
            </button>
        </div>
    </div>
    {% endif %}

    <!-- Creator Actions -->
    {% if is_creator %}
    <div class="creator-actions">
        <h3 class="creator-title">Poll Creator Actions</h3>
        <div class="creator-buttons">
            {% if poll.is_closed %}
            <button class="btn btn-secondary" onclick="Pollivu.Poll.reopenPoll('{{ poll.id }}')">
                {{ icon('reopen') }}
                Reopen Poll
            </button>
            {% elif not poll.is_expired %}
            <button class="btn btn-secondary" onclick="Pollivu.Poll.closePoll('{{ poll.id }}')">
                {{ icon('private') }}
                Close Poll
            </button>
            {% endif %}
            <button class="btn btn-danger" onclick="Pollivu.Poll.confirmDelete('{{ poll.id }}')">
                {{ icon('delete') }}
                Delete Poll
            </button>
        </div>
    </div>
    {% endif %}
</div>

{% include 'components/_qr_modal.html' %}

<!-- Delete Confirmation Modal -->
<div class="modal" id="delete-modal">
    <div class="modal-overlay modal-close"></div>
    <div class="modal-content">
        <h3 class="modal-title">Delete Poll?</h3>
        <p class="modal-text">This action cannot be undone. All votes will be permanently deleted.</p>
        <div class="modal-actions">
            <button class="btn btn-secondary modal-close">Cancel</button>
            <button class="btn btn-danger" onclick="Pollivu.Poll.executeDelete()">Delete</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // QR Modal functions are now in components/_qr_modal.html

    const pollId = '{{ poll.id }}';
    const isPollActive = {{ 'true' if poll.is_active else 'false' }};
    let lastTotalVotes = parseInt(document.getElementById('total-votes-count')?.textContent || '0');
    let lastPollStatus = null;
    let lastUpdatedAt = null;

    // Poll for real-time updates every 3 seconds
    const pollInterval = setInterval(async () => {
        try {
            const res = await fetch(`/api/poll/${pollId}/live_stats`);
            if (!res.ok) return;
            const stats = await res.json();

            // Detect any settings change via updated_at timestamp
            if (lastUpdatedAt !== null && stats.updated_at !== lastUpdatedAt) {
                // Settings changed â€” reload to reflect new question, visibility, etc.
                window.location.reload();
                return;
            }
            lastUpdatedAt = stats.updated_at;

            // Update results if vote count changed
            if (stats.total_votes !== lastTotalVotes) {
                // If going from 0 to first vote, reload to show chart/list
                if (lastTotalVotes === 0 && stats.total_votes > 0) {
                    window.location.reload();
                    return;
                }
                updatePollResults({
                    poll_id: pollId,
                    total_votes: stats.total_votes,
                    results: stats.results
                });
                fetchAnalytics();
                lastTotalVotes = stats.total_votes;
            }

            // Check for status changes (closed/reopened)
            const statusKey = `${stats.is_active}`;
            if (lastPollStatus !== null && statusKey !== lastPollStatus) {
                if (!stats.is_active) {
                    Toast.show('This poll has been closed by the creator.', 'info');
                } else {
                    Toast.show('This poll has been reopened!', 'success');
                }
                setTimeout(() => window.location.reload(), 1500);
            }
            lastPollStatus = statusKey;
        } catch (e) {
            // Silently ignore fetch errors
        }
    }, 3000);

    // Stop polling when user leaves the page
    window.addEventListener('beforeunload', () => clearInterval(pollInterval));

    function updatePollResults(data) {
        // Update total votes
        const totalVotesElement = document.getElementById('total-votes-count');
        if (totalVotesElement) totalVotesElement.textContent = data.total_votes;

        // Update each option
        data.results.forEach(option => {
            const optionElement = document.querySelector(`.result-item[data-option-id="${option.id}"]`);
            if (optionElement) {
                // Update vote count
                const voteCountElement = optionElement.querySelector('.vote-count');
                if (voteCountElement) voteCountElement.textContent = option.vote_count;

                // Update percentage text
                const percentageElement = optionElement.querySelector('.percentage');
                if (percentageElement) percentageElement.textContent = option.percentage;

                // Update progress bar width
                const progressBar = optionElement.querySelector('.result-bar');
                if (progressBar) progressBar.style.width = `${option.percentage}%`;
            }
        });
    }

    function copyLinkToClipboard() {
        navigator.clipboard.writeText(window.location.href).then(() => {
            Toast.show('Link copied to clipboard!', 'success');
        }).catch(err => {
            console.error('Failed to copy: ', err);
            Toast.show('Failed to copy link', 'error');
        });
    }

    // --- Analytics & Visualizations ---
    let timeChart = null;
    let currentGranularity = 'hourly';

    // Granularity tab click handlers
    document.querySelectorAll('.granularity-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.granularity-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            currentGranularity = this.dataset.granularity;
            fetchAnalytics();
        });
    });

    function fetchAnalytics() {
        fetch(`/api/poll/${pollId}/analytics?granularity=${currentGranularity}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    renderTimeChart(data.timeline, currentGranularity);
                }
            })
            .catch(err => console.error("Analytics error:", err));
    }

    function renderTimeChart(timeline, granularity) {
        const ctx = document.getElementById('votesTimeChart');
        if (!ctx) return;

        const emptyState = document.getElementById('timeline-empty');

        if (!timeline || timeline.length === 0) {
            ctx.style.display = 'none';
            if (emptyState) emptyState.style.display = 'flex';
            return;
        }
        ctx.style.display = 'block';
        if (emptyState) emptyState.style.display = 'none';

        // Format labels based on granularity
        const labels = timeline.map(item => {
            try {
                const parts = item.time.split(' ');
                const datePart = parts[0]; // YYYY-MM-DD
                const timePart = parts[1] || ''; // HH:00 (hourly only)
                const d = datePart.split('-');
                const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                if (granularity === 'daily' || granularity === 'cumulative') {
                    return months[parseInt(d[1])-1] + ' ' + parseInt(d[2]);
                }
                return months[parseInt(d[1])-1] + ' ' + parseInt(d[2]) + ', ' + timePart;
            } catch(e) { return item.time; }
        });
        const counts = timeline.map(item => item.count);

        // For cumulative mode, compute running total
        let chartData = counts;
        let chartLabel = 'Votes';
        if (granularity === 'cumulative') {
            chartData = [];
            let running = 0;
            for (const c of counts) {
                running += c;
                chartData.push(running);
            }
            chartLabel = 'Total Votes';
        }

        if (timeChart) {
            timeChart.data.labels = labels;
            timeChart.data.datasets[0].data = chartData;
            timeChart.data.datasets[0].label = chartLabel;
            timeChart.update();
        } else {
            timeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: chartLabel,
                        data: chartData,
                        borderColor: '#10B981',
                        borderWidth: 2.5,
                        backgroundColor: function(context) {
                            const chart = context.chart;
                            const { ctx: c, chartArea } = chart;
                            if (!chartArea) return 'rgba(16, 185, 129, 0.1)';
                            const gradient = c.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
                            gradient.addColorStop(0, 'rgba(16, 185, 129, 0.25)');
                            gradient.addColorStop(1, 'rgba(16, 185, 129, 0.02)');
                            return gradient;
                        },
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#10B981',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverBorderWidth: 3,
                        pointHoverBackgroundColor: '#059669'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#064E3B',
                            titleFont: { family: 'Work Sans', size: 12, weight: '600' },
                            bodyFont: { family: 'Work Sans', size: 13 },
                            padding: 12,
                            cornerRadius: 10,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    const v = context.parsed.y;
                                    return v + ' vote' + (v !== 1 ? 's' : '');
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: {
                                font: { family: 'Work Sans', size: 11 },
                                color: '#9CA3AF',
                                maxRotation: 45,
                                maxTicksLimit: 8
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.04)', drawBorder: false },
                            ticks: {
                                precision: 0,
                                font: { family: 'Work Sans', size: 11 },
                                color: '#9CA3AF'
                            }
                        }
                    }
                }
            });
        }
    }

    // Load analytics on init
    document.addEventListener('DOMContentLoaded', fetchAnalytics);

    function copyEmbedCode(id) {
        var embedUrl = window.location.origin + '/poll/' + id + '/embed';
        var code = '<iframe src="' + embedUrl + '" width="100%" height="480" style="border:none;border-radius:12px;" loading="lazy"></iframe>';
        navigator.clipboard.writeText(code).then(function() {
            if (typeof Toast !== 'undefined') Toast.show('Embed code copied!', 'success');
        }).catch(function() {
            prompt('Copy this embed code:', code);
        });
    }

</script>
{% endblock %}